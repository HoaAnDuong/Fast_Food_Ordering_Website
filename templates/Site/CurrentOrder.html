{% extends 'Site/index.html' %}
{% block content %}
    <div class = "container-fluid">
        {% if user.is_authenticated %}
            {% if current_order %}
            <ul class="nav nav-tabs">
              <li><a href="/profile">Thông tin</a></li>
              <li class="active"><a href="/current-order">Đơn hàng hiện tại</a></li>
            </ul>
            <br>

            <ul class="col-md-2 nav nav-pills nav-stacked">
                <li class="active"><a data-toggle = "tab" href="#profile">Thông tin Đơn Hàng</a></li>

            </ul>
            <div class = "col-md-8 tab-content">
                <div class = "tab-pane fade in active" id = "profile">
                    <form method = "POST">
                        {% csrf_token %}
                        <div>
                            <h2>Đơn hàng hiện tại</h2>
                        </div>
                        <input type="hidden" name="method_tag" value = "update_order" readonly>
                        <div>
                            <h4>Thời điểm khởi tạo:</h4>
                            <label>{{current_order.created}}</label>
                        </div>
                        <div>
                            <h4>Phương thức thanh toán</h4>

                            <select name="payment_method">
                                {% for payment_method in payment_methods %}
                                    <option value = {{payment_method.id}} {% if current_order.payment_method == payment_method %}selected{% endif %}>{{payment_method.code}}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <h4>Tình trạng đơn hàng:</h4>
                            <label>{{current_order.order_status.code}}</label>
                        </div>
                        <div>
                            <h4>Tổng tiền:</h4>
                            <label>{{current_order.total}}</label>
                        </div>
                        <button type="submit" class="btn btn-primary">Cập nhật</button>
                    </form>

                    <form method = "POST">
                        <h3>Giỏ hàng({{current_order.total_quantity}}):</h3>
                        <table class = "table table-hover">
                            <thead>
                                <tr>
                                    <th>Tên món</th>
                                    <th>Hình ảnh</th>
                                    <th>Đơn Giá</th>
                                    <th>Số lượng</th>
                                    <th>Tổng</th>
                                    <th>Hành động</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order_product in current_order.order_products.all %}
                                <tr>
                                    <td><a href = "/product/{{order_product.product.slug}}"><h5>{{order_product.product.name}}</h5></a></td>
                                    <td><img style = "width:100px; height:62px;" src = "{{order_product.product.image.url}}"></td>
                                    <td>{{order_product.product.price}}</td>
                                    <td>{{order_product.quantity}}</td>
                                    <td>{{order_product.price}}</td>
                                    <td>
                                        <button type="button" class="btn" data-toggle="modal" data-target="#order_product_modal_{{forloop.counter0}}">
                                            Cập Nhật
                                        </button>
                                        <div id = "order_product_modal_{{forloop.counter0}}" class = "modal fade" role="dialog">
                                            <div class="modal-dialog">
                                                {% if user.is_authenticated %}
                                                    {% if not product.store == user.store %}
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                                                                <h4 class="modal-title">
                                                                    Cập nhật món: {{order_product.product.name}}
                                                                </h4>
                                                        </div>
                                                        <form method = "POST">
                                                                {% csrf_token %}
                                                                <input type = "hidden" name = "method_tag" value = "update_product" readonly>
                                                                <input type = "hidden" name = "product_id" value = "{{order_product.product.id}}" readonly>
                                                                <div class="modal-body">
                                                                    <div class = "form-group">
                                                                        <label>Số Lượng</label>
                                                                        <br>
                                                                        <input type="number" name = "quantity" value = "" min = "1" max = "15">
                                                                    </div>
                                                                    <div class = "form-group">
                                                                        <label style = "display: flex">Ghi chú</label>
                                                                        <br>
                                                                        <textarea name = "note" style = "width:500px; height:250px" maxlength="255"></textarea>
                                                                    </div>
                                                                </div>
                                                                <div class="modal-footer">
                                                                    <button type="submit" class="btn btn-primary" onClick="window.location.reload()">Xác nhận</button>
                                                                    <button type="button" class="btn btn-default" data-dismiss="modal">Hủy</button>
                                                                </div>
                                                            </form>
                                                    </div>
                                                    {% endif %}
                                                {% else %}
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                                                                <h4 class="modal-title">Yêu cầu đăng nhập</h4>
                                                        </div>
                                                        <div class="modal-body">
                                                            <label>Bạn cần phải đăng nhập để mua hàng</label>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-default" data-dismiss="modal">Thoát</button>
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#delete_product_modal_{{forloop.counter0}}">Xóa món</button>
                                        <div id = "delete_product_modal_{{forloop.counter0}}" class = "modal fade" role="dialog">
                                            <div class="modal-dialog">
                                                {% if user.is_authenticated %}
                                                    {% if not product.store == user.store %}
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                                                                <h4 class="modal-title">
                                                                    Xóa món: {{order_product.product.name}} - Số lượng: {{order_product.quantity}}
                                                                </h4>
                                                        </div>
                                                        <form method = "POST">
                                                            {% csrf_token %}
                                                                <div class = "modal-body">
                                                                    <input type = "hidden" name = "method_tag" value = "delete_product" readonly>
                                                                    <input type = "hidden" name = "product_id" value = "{{order_product.product.id}}" readonly>
                                                                    <h4>Bạn có chắc chắn muốn xóa {{product.name}} với số lượng {{order_product.quantity}} ra khỏi giỏ hàng?</h4>
                                                                </div>

                                                                <div class="modal-footer">
                                                                    <button type="submit" class="btn btn-primary" onClick="window.location.reload()">Xác nhận</button>
                                                                    <button type="button" class="btn btn-default" data-dismiss="modal">Hủy</button>
                                                                </div>
                                                            </form>
                                                    </div>
                                                    {% endif %}
                                                {% else %}
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                                                                <h4 class="modal-title">Yêu cầu đăng nhập</h4>
                                                        </div>
                                                        <div class="modal-body">
                                                            <label>Bạn cần phải đăng nhập để mua hàng</label>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-default" data-dismiss="modal">Thoát</button>
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                                <tr>
                                    <td>Tổng</td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td>{{current_order.total}}</td>
                                </tr>
                            </tbody>

                        </table>

                    </form>

                    {% if store_list %}
                        <h3>Danh Sách Cửa Hàng</h3>
                        <input type = "hidden" id="num_of_store" value = "{{store_list|length}}">
                        {% for i in store_list %}
                            <label id="store_{{ forloop.counter0 }}_name">{{i.name}}</label>
                            <label>{{i.location.address}}</label>
                            <input type = "hidden" id="store_{{ forloop.counter0 }}_lat" value = {{i.location.lat}}>
                            <input type = "hidden" id="store_{{ forloop.counter0 }}_lng" value = {{i.location.lng}}>
                            <input type = "hidden" id="store_{{ forloop.counter0 }}_address" value = "{{i.location.address}}">
                            <br>
                        {% endfor %}
                    {% endif %}
                   <form method = "POST" id = "location">
                       {% csrf_token %}
                        <input type="hidden" name="method_tag" value = "location" readonly>
                        <div>
                            <h3>Vị trí giao hàng:</h3>
                            <div>
                                <label>Vĩ độ</label>
                                <input type = "text" id="lat" name="lat" value = {{current_order.destination.lat}} readonly>
                            </div>
                            <div>
                                <label>Kinh độ</label>
                                <input type = "text" id="lng" name="lng" value = {{current_order.destination.lng}} readonly>
                            </div>
                            <div>
                                <label>Địa chỉ</label>
                                <br>
                                <input type = "text" id="address" name="address" value = "{{current_order.destination.address}}">
                            </div>

                            <div>
                                <input type = "hidden" id="country" name="country" value = "{{current_order.destination.country}}" readonly>
                            </div>
                            <div>
                                <input type = "hidden" id="region" name="region" value = "{{current_order.destination.region}}" readonly>
                            </div>
                            <div>
                                <input type = "hidden" id="subregion_1" name="subregion_1" value = "{{current_order.destination.subregion_1}}" readonly>
                            </div>
                            <div>
                                <input type = "hidden" id="subregion_2" name="subregion_2" value = "{{current_order.destination.subregion_2}}" readonly>
                            </div>
                            <div id = "map" style = "height:50vw; width:80vw; "></div>
                            <button type="submit" class="btn btn-primary">Xác nhận</button>
                        </div>
                        {% if error == "location" %}
                        {% for msg in messages %}
                            <small style="color:red">{{msg}}</small>
                            <br>
                        {% endfor %}
                        {% endif %}
                        <button type="submit" class="btn btn-primary">Cập nhật</button>
                    </form>
                </div>
                <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
                <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
                <script src="https://unpkg.com/leaflet-ant-path@1.3.0/dist/leaflet-ant-path.js" type="text/javascript"></script>

                <script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"></script>
                <script src="https://unpkg.com/esri-leaflet-vector@4.0.1/dist/esri-leaflet-vector.js"></script>

                <script src="https://unpkg.com/esri-leaflet-geocoder@3.1.4/dist/esri-leaflet-geocoder.js"></script>

                <script src="https://unpkg.com/@esri/arcgis-rest-request@4.0.0/dist/bundled/request.umd.js"></script>
                <script src="https://unpkg.com/@esri/arcgis-rest-routing@4.0.0/dist/bundled/routing.umd.js"></script>
                {% load static %}

                <script src="{% static 'js/product-location-2.js' %}"></script>
            </div>
            {% else %}
                {% if user.profile.is_customer %}
                <div class = "form-default">
                    <form method = "POST">
                        {% csrf_token %}
                        <input type="hidden" name="method_tag" value = "create_order" readonly>
                        <button class = "btn" style = "display: flex; justify-content: space-between;">Tạo Đơn Hàng Mới</button>
                    </form>
                </div>
                {% else %}
                <div>
                    <meta http-equiv="refresh" content="1; url='/'">
                    <h3>Bạn không còn vai trò Khách Hàng nên không thể đặt thêm đơn hàng mới.</h3>
                </div>
                {% endif %}

            {% endif %}


        {% else %}
          <meta http-equiv="refresh" content="1; url='/login'" />
          <div>
              <h3>You are not logged in now, so you will be directed to Login Page</h3>
          </div>
        {% endif %}
    </div>
{% endblock %}